<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<header class="header">
  <h1>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h1>
  <button class="btn" onclick="logout()">–í—ã–π—Ç–∏</button>
</header>

<div class="container" style="padding:24px 40px;">

  <div class="tabs">
    <button class="tab-btn active" data-tab="orders">–ó–∞–∫–∞–∑—ã</button>
    <button class="tab-btn" data-tab="users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
  </div>

  <div class="panel active" id="ordersPanel">
    <div id="ordersList"></div>
  </div>

  <div class="panel" id="usersPanel">
    <div id="usersList"></div>
  </div>

</div>

<script>
const SERVER_URL = "https://ofd-backend-czgu.onrender.com";

let adminToken = localStorage.getItem("adminToken");
if (!adminToken) startAdminLogin();

function startAdminLogin() {
  fetch(SERVER_URL + "/api/admin/request-login", { method: "POST", headers: { "Content-Type": "application/json" } })
  .then(r => r.json())
  .then(async ({ nonce }) => {

    alert("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—Ö–æ–¥ –≤ Telegram");

    let tries = 0;
    const maxTries = 20;

    while (tries < maxTries) {
      const check = await fetch(SERVER_URL + "/api/admin/check?nonce=" + nonce).then(r => r.json());
      if (check.verified) {
        const tokenData = await fetch(SERVER_URL + "/api/admin/token?nonce=" + nonce).then(r => r.json());
        adminToken = tokenData.token;
        localStorage.setItem("adminToken", adminToken);
        loadAdminData();
        return;
      }
      await new Promise(r => setTimeout(r, 3000));
      tries++;
    }
    alert("–í—Ö–æ–¥ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω");
  });
}

function api(url, method="GET", data=null) {
  return fetch(SERVER_URL + url, {
    method,
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + adminToken
    },
    body: data ? JSON.stringify(data) : null
  }).then(r => r.json());
}

async function loadAdminData() {
  loadOrders();
  loadUsers();
}

async function loadOrders() {
  const orders = await api("/api/admin/orders");
  const box = document.getElementById("ordersList");
  box.innerHTML = "";
  orders.forEach(o => {
    box.innerHTML += `
    <div class="card">
      <div class="card-title">–ó–∞–∫–∞–∑ ‚Ññ${o.number} ‚Äî ${o.status}</div>
      <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b>${o.userLogin}</b></div>
      <div>–¢–æ–≤–∞—Ä: ${o.items.map(i => `${i.title} √ó ${i.count}`).join(", ")}</div>
      <div>–°—É–º–º–∞: ${o.total} ‚ÇΩ</div>
      <input placeholder="–ö–ª—é—á" id="key_${o.id}" value="${o.key || ""}" style="margin-top:8px;">
      <button class="save-btn" onclick="fulfill('${o.id}')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>`;
  });
}

async function fulfill(id) {
  const key = document.getElementById("key_" + id).value;
  await api("/api/admin/orders/" + id + "/fulfill", "POST", { key });
  loadOrders();
}

async function loadUsers() {
  const users = await api("/api/admin/users");
  const box = document.getElementById("usersList");
  box.innerHTML = "";
  users.forEach(u => {
    box.innerHTML += `
    <div class="card">
      <div class="card-title">${u.login}</div>
      <div>${u.surname} ${u.name}</div>
      <div>${u.email}</div>
      <div>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${new Date(u.createdAt).toLocaleDateString()}</div>
      <div>–ó–∞–∫–∞–∑–æ–≤: ${u.orderCount}</div>
      <div>–°—Ç–∞—Ç—É—Å: ${u.banned ? "üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" : "‚úî –ê–∫—Ç–∏–≤–µ–Ω"}</div>
      <button class="btn-small" onclick="toggleBan('${u.id}')">
        ${u.banned ? "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" : "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å"}
      </button>
      <button class="btn-small" onclick="resetPass('${u.id}')">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
      <button class="btn-small danger" onclick="deleteUser('${u.id}')">–£–¥–∞–ª–∏—Ç—å</button>
    </div>`;
  });
}

async function toggleBan(id) {
  await api("/api/admin/users/" + id + "/ban", "POST");
  loadUsers();
}

async function resetPass(id) {
  const r = await api("/api/admin/users/" + id + "/password", "POST");
  alert("–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω\n–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å: " + r.newPass);
  loadUsers();
}

async function deleteUser(id) {
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
  await api("/api/admin/users/" + id, "DELETE");
  loadUsers();
}

document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab+"Panel").classList.add("active");
  }
});

function logout() {
  localStorage.removeItem("adminToken");
  location.reload();
}

loadAdminData();
</script>
</body>
</html>
