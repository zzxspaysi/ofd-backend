<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ü—Ä–æ—Ñ–∏–ª—å</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<header class="header">
    <h1 id="helloUser">–ü—Ä–æ—Ñ–∏–ª—å</h1>
    <button class="btn" onclick="logout()">–í—ã–π—Ç–∏</button>
</header>

<div class="container" style="padding:24px 40px;">
    <div class="tabs">
        <button class="tab-btn active" data-tab="orders">–¢–µ–∫—É—â–∏–µ –∑–∞–∫–∞–∑—ã</button>
        <button class="tab-btn" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</button>
        <button class="tab-btn" data-tab="keys">–ú–æ–∏ –∫–ª—é—á–∏</button>
        <button class="tab-btn" data-tab="password">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
    </div>

    <div class="panel active" id="ordersPanel">
        <div id="ordersList" class="list"></div>
    </div>

    <div class="panel" id="historyPanel">
        <div id="historyList" class="list"></div>
    </div>

    <div class="panel" id="keysPanel">
        <div id="keysList" class="list"></div>
    </div>

    <div class="panel" id="passwordPanel">
        <input id="oldPass" type="password" placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å">
        <input id="newPass" type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω. 4 —Å–∏–º–≤–æ–ª–∞)">
        <button class="save-btn" onclick="changePassword()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div class="info" id="passMsg"></div>
    </div>
</div>

<script>
const SERVER_URL = "https://ofd-backend-czgu.onrender.com";

let token = localStorage.getItem("token");
if (!token) location.href = "index.html";

function api(url, method="GET", data=null) {
    return fetch(SERVER_URL + url, {
        method,
        headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
        },
        body: data ? JSON.stringify(data) : null
    }).then(r => r.json());
}

async function loadProfile() {
    const me = await api("/api/me");
    document.getElementById("helloUser").innerText = `–ü—Ä–∏–≤–µ—Ç, ${me.name}! üëã`;
    loadOrders();
    loadHistory();
    loadKeys();
}

async function loadOrders() {
    const orders = await api("/api/orders");
    renderOrders(orders, "ordersList");
}

async function loadHistory() {
    const history = await api("/api/orders/history");
    renderOrders(history, "historyList");
}

async function loadKeys() {
    const keys = await api("/api/user/keys");
    const box = document.getElementById("keysList");
    box.innerHTML = keys.length === 0 ? "–ü–æ–∫–∞ –Ω–µ—Ç –∫–ª—é—á–µ–π" : "";
    keys.forEach(k => {
        box.innerHTML += `
        <div class="card">
            <div class="card-title">–ó–∞–∫–∞–∑ ‚Ññ${k.orderNumber}</div>
            <div>–¢–æ–≤–∞—Ä: ${k.product}</div>
            <div>–ö–ª—é—á: <b>${k.key}</b></div>
            <div>–î–∞—Ç–∞: ${new Date(k.createdAt).toLocaleDateString()}</div>
        </div>`;
    });
}

function renderOrders(list, id) {
    const box = document.getElementById(id);
    box.innerHTML = list.length === 0 ? "–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤" : "";
    list.forEach(o => {
        box.innerHTML += `
        <div class="card">
            <div class="card-title">‚Ññ${o.number} ‚Äî ${o.status}</div>
            <div>–°—É–º–º–∞: ${o.total} ‚ÇΩ</div>
            <div>–¢–æ–≤–∞—Ä: ${o.items.map(i=>`${i.title} √ó ${i.count}`).join(", ")}</div>
            <div>–î–∞—Ç–∞: ${new Date(o.createdAt).toLocaleDateString()}</div>
        </div>`;
    });
}

async function changePassword() {
    const msg = document.getElementById("passMsg");
    const oldPass = document.getElementById("oldPass").value;
    const newPass = document.getElementById("newPass").value;
    const r = await api("/api/user/password", "POST", { oldPass, newPass });
    msg.innerText = r.ok ? "–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω ‚úî" : (r.error || "–û—à–∏–±–∫–∞");
    msg.style.color = r.ok ? "#00ff80" : "red";
}

function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("user");
    location.href = "index.html";
}

document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab+"Panel").classList.add("active");
    }
});

loadProfile();
</script>
</body>
</html>
